#!/bin/sh
RUNS_IN_NOMAD=false
COOKLOG=/var/log/cook.log

pot_seasoned_exit() {
    [ ! -e /usr/local/etc/pot-is-seasoned ] && \
      touch /usr/local/etc/pot-is-seasoned
    # If this pot flavour is blocking (i.e. it should not return), there is
    # no /tmp/environment.sh created by pot and we now after configuration
    # block indefinitely
    if [ "$RUNS_IN_NOMAD" = "true" ]; then
        /bin/sh /etc/rc
        tail -f /dev/null
    fi
    exit 0
}

# always disable sshd, we don't need direct access
# XXX: Do this when baking the image
service sshd stop || true
service sshd disable || true

# No need to change this, just ensures configuration is done only once
[ -e /usr/local/etc/pot-is-seasoned ] && pot_seasoned_exit

########################################################################
## Functions and settings
########################################################################

log() {
    echo "$(date '+%Y-%m-%dT%H:%M:%S') $*" | tee -a $COOKLOG
}

set -e
export HOME=/root

if [ -e /tmp/environment.sh ]
then
    # shellcheck disable=SC1091
    . /tmp/environment.sh

    # XXX: Remove some things from here later
    cp -a /tmp/environment.sh /root/.env.cook
fi

# stop services
service vault onestop || true
timeout --foreground 10 \
  service consul onestop || service consul onestop || true

killall -9 consul || true

########################################################################
## Check config
########################################################################

required_args="DATACENTER IP NODENAME VAULTSERVER ATTL BTTL"
required_args="$required_args PEERS BOOTSTRAP "
optional_args="REMOTELOG"

for var in $required_args; do
  if [ -z "$(eval echo "\${$var}")" ]; then
    log "$var is unset - see documentation to configure this flavour."
    exit 1
  fi
done

for var in $optional_args; do
  if [ -z "$(eval echo "\${$var}")" ]; then
    log "Optional $var is unset - see documentation to configure this flavour."
    eval $var=null
  fi
done

########################################################################
## Provision image
########################################################################

export PATH=/usr/local/share/cook/bin:$PATH

# install consul-template
log "Installing consul-template"
pkg install -y consul-template

log "Patching and cloning consul-template rc scripts"
sed -i '' 's/^\(start_precmd=consul_template_startprecmd\)$/\1;'\
'extra_commands=reload/'  /usr/local/etc/rc.d/consul-template

# setup directories for vault usage
mkdir -p /mnt/templates
mkdir -p /mnt/certs/hash
mkdir -p /mnt/consulcerts
chown -R consul /mnt/consulcerts
mkdir -p /mnt/metricscerts
mkdir -p /mnt/vault/

# add temporary /etc/hosts entry
echo "$VAULTSERVER active.vault.service.consul" >>/etc/hosts

# create nodeexport user, needed for chown, removed from config node_exporter script
/usr/sbin/pw useradd -n nodeexport -c 'nodeexporter user' -m -s /usr/bin/nologin -h -

log "Unwrap cluster credentials"
unwrap-cluster-credentials.sh

log "Unwrap consul credentials"
unwrap-consul-credentials.sh

log "Configure consul-template"
configure-consul-template.sh

log "Starting consul-template"
service consul-template start

log "Waiting up to 20 seconds for consul-template to start"
timeout --foreground 20 \
  sh -c 'while ! service consul-template status; do sleep 1; done'

log "Configure consul"
configure-consul.sh

log "Start consul and wait for it to become stable"
timeout --foreground 120 \
  sh -c 'while ! service consul status; do
    sleep 5; service consul start || true; sleep 5;
  done'

log "Set up local_unbound"
setup-local-unbound.sh

log "Symlink helper scripts"
ln -s /usr/local/share/cook/bin/consul.sh /root/consul.sh

# setup node_exporter
log "Unwrap metrics credentials"
unwrap-metrics-credentials.sh

# setup metrics pki stuff
log "Configure metrics certificates"
configure-metrics.sh

# setup node exporter
log "Setup node_exporter"
configure-node-exporter.sh

# setup consul-template for metrics
log "Start consul-template-metrics"
service consul-template-metrics start

# make sure we start node_exporter
log "Start node_exporter"
service node_exporter start

pot_seasoned_exit

#### XXX: Add syslog things back in

# setup syslog-ng
# optional remote logging
if [ -n "$REMOTELOG" ] && [ "$REMOTELOG" != "null" ]; then
    if [ -f /root/syslog-ng.conf ]; then
        /usr/bin/sed -i .orig "s/REMOTELOGIP/$REMOTELOG/g" /root/syslog-ng.conf
        cp -f /root/syslog-ng.conf /usr/local/etc/syslog-ng.conf
        # stop syslogd
        service syslogd onestop || true
        # setup sysrc entries to start and set parameters to accept logs from remote subnet
        sysrc syslogd_enable="NO"
        sysrc syslog_ng_enable="YES"
        #sysrc syslog_ng_flags="-u daemon"
        sysrc syslog_ng_flags="-R /tmp/syslog-ng.persist"
        /usr/local/etc/rc.d/syslog-ng start
        echo "syslog-ng setup complete"
    else
        echo "/root/syslog-ng.conf is missing?"
    fi
else
    echo "REMOTELOG parameter is not set to an IP address. syslog-ng won't operate."
fi

## end consul setup

# ADJUST THIS: START THE SERVICES AGAIN AFTER CONFIGURATION

# this seems to be a duplicate as started above?
log "Start consul agent"
service consul start

pot_seasoned_exit
